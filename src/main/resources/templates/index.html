<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Meani Real Estate</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<header class="header">
    <div class="logo">
        <span class="symbol-m">M</span><span class="text-rest">eani</span>
    </div>

    <nav class="nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/properties">Properties</a>
        <a href="/contracts">Contracts</a>
        <a href="/payments">Payments</a>
        <button class="btn-contact" id="contactUs">Contact Us</button>
    </nav>

    <div class="actions">
        <span class="icon">üîç</span>
        <span class="icon">üë§</span>
        <button class="btn-login" id="openLogin">Sign in</button>
    </div>
</header>

<section class="hero">
    <div class="hero-left">
        <h1>
            Find Your<br>
            Dream Home
        </h1>

        <p>
            Explore our curated selection of exquisite properties
            meticulously tailored to your unique dream home vision
        </p>
    </div>

    <div class="hero-right">
        <img src="/img/house.png" alt="Modern House">
    </div>
</section>

<!-- Login Modal -->
<div id="overlay" class="overlay"></div>
<div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeLogin">&times;</span>
        <h2>Welcome Back</h2>
        <p class="modal-subtitle">Sign in to your account</p>
        <form onsubmit="handleLogin(event)">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" placeholder="Enter your username" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" placeholder="Enter your password" required>
            </div>
            <div class="form-remember">
                <input type="checkbox" id="remember" name="remember">
                <label for="remember" class="remember-label">Remember me</label>
            </div>
            <div id="loginError" style="color: red; margin-top: 10px; display: none;"></div>
            <button type="submit" class="btn-submit">Sign In</button>
        </form>
    </div>
</div>


<div id="contactModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeContact">&times;</span>
        <h2>Contact Us</h2>
        <p class="modal-subtitle">If you have any questions, please fill out the form below and we will get back to you shortly.</p>
        <form action="/contact" method="post">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="emailContact" name="email" placeholder="your@email.com" required>
            </div>
            <div class="form-group">
                <label for="message">Message</label>
                <textarea id="message" name="message" placeholder="Enter your message" required></textarea>
            </div>
            <button type="submit" class="btn-submit">Send</button>
        </form>
    </div>
</div>

<!-- <script src="script.js"> -->
<script>
    const links = document.querySelectorAll(".nav a");
    const currentPath = window.location.pathname.split("/").pop();

    links.forEach(link => {
        if (link.getAttribute("href") === currentPath) {
            link.classList.add("active");
        }
    });


    const overlay = document.getElementById("overlay");

    const loginModal = document.getElementById("loginModal");
    const contactModal = document.getElementById("contactModal");

    const openLogin = document.getElementById("openLogin");
    const openContact = document.getElementById("contactUs");

    const closeLogin = document.getElementById("closeLogin");
    const closeContact = document.getElementById("closeContact");

    // Open login
    openLogin.onclick = () => {
        loginModal.style.display = "block";
        overlay.style.display = "block";
    };

    // Open contact
    openContact.onclick = () => {
        contactModal.style.display = "block";
        overlay.style.display = "block";
    };

    // Close login
    closeLogin.onclick = () => {
        loginModal.style.display = "none";
        overlay.style.display = "none";
    };

    // Close contact
    closeContact.onclick = () => {
        contactModal.style.display = "none";
        overlay.style.display = "none";
    };

    // Click overlay to close all
    overlay.onclick = () => {
        loginModal.style.display = "none";
        contactModal.style.display = "none";
        overlay.style.display = "none";
    };

    /**
     * H√†m handleLogin: X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
     *
     * Qu√° tr√¨nh:
     * 1. NgƒÉn form submit m·∫∑c ƒë·ªãnh
     * 2. L·∫•y username + password t·ª´ input
     * 3. G·ª≠i POST ƒë·∫øn /api/auth/login
     * 4. N·∫øu OK ‚Üí l∆∞u token + redirect dashboard
     * 5. N·∫øu l·ªói ‚Üí hi·ªÉn th·ªã th√¥ng b√°o l·ªói
     */
    function handleLogin(event) {
        event.preventDefault();  // NgƒÉn form refresh page

        // 1. L·∫•y gi√° tr·ªã t·ª´ form
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        // 2. G·ª≠i request ƒë·∫øn backend
        fetch('/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: username,
                password: password
            })
        })
            .then(response => {
                // Ki·ªÉm tra HTTP status (200, 401, 500...)
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                return response.json();  // Parse JSON
            })
            .then(data => {
                // 3. X·ª≠ l√Ω response t·ª´ backend

                console.log('Login response:', data);  // Debug

                if (data.status === 'FIRST_LOGIN') {
                    // L·∫ßn ƒë·∫ßu ƒëƒÉng nh·∫≠p ‚Üí c·∫ßn ƒë·ªïi m·∫≠t kh·∫©u
                    alert('Vui l√≤ng ƒë·ªïi m·∫≠t kh·∫©u l·∫ßn ƒë·∫ßu ƒëƒÉng nh·∫≠p');
                    window.location.href = `/change-password.html?accountId=${data.accountId}`;
                }
                else if (data.status === 'SUCCESS') {
                    // ƒêƒÉng nh·∫≠p th√†nh c√¥ng

                    // 4. L∆∞u token + th√¥ng tin user v√†o localStorage
                    localStorage.setItem('token', data.accountId);  // L∆∞u account ID l√†m token
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('userRole', data.role);

                    // 5. ƒê√≥ng modal
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('overlay').style.display = 'none';

                    // X√≥a form
                    document.querySelector('#loginModal form').reset();

                    // 6. Redirect ƒë·∫øn dashboard
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 500);
                }
            })
            .catch(error => {
                // 7. X·ª≠ l√Ω l·ªói
                console.error('Login error:', error);

                const errorDiv = document.getElementById('loginError');
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra username/password';
            });
    }

    /**
     * H√†m logout: X√≥a token + redirect v·ªÅ login
     * G·ªçi h√†m n√†y khi user b·∫•m n√∫t "ƒêƒÉng xu·∫•t"
     */
    function handleLogout() {
        // 1. X√≥a token t·ª´ localStorage
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        localStorage.removeItem('userRole');

        // 2. Redirect v·ªÅ trang login
        window.location.href = '/';
    }

    /**
     * H√†m checkAuthStatus: Ki·ªÉm tra xem user ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
     *
     * D√πng tr√™n trang dashboard:
     * - N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p ‚Üí redirect v·ªÅ login
     * - N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p ‚Üí load d·ªØ li·ªáu
     *
     * G·ªçi h√†m n√†y ·ªü ƒë·∫ßu trang dashboard.html
     */
    function checkAuthStatus() {
        const token = localStorage.getItem('token');

        if (!token) {
            console.log('Kh√¥ng c√≥ token, redirect v·ªÅ login');
            window.location.href = '/';
        } else {
            console.log('Token c√≥, user ƒë√£ ƒëƒÉng nh·∫≠p');
        }
    }

    // ========== GET REQUEST V·ªöI TOKEN ==========

    /**
     * H√†m fetchWithAuth: G·ªçi API v·ªõi token trong header
     *
     * C√°ch d√πng:
     * fetchWithAuth('/api/properties')
     *     .then(data => console.log(data))
     *
     * Ho·∫∑c v·ªõi body:
     * fetchWithAuth('/api/properties', {
     *     method: 'POST',
     *     body: JSON.stringify({name: 'New Property'})
     * })
     */
    function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('token');

        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        return fetch(url, {
            ...options,
            headers: headers
        })
            .then(response => {
                if (response.status === 401) {
                    // Token h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá
                    alert('Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i');
                    handleLogout();
                    throw new Error('Unauthorized');
                }
                return response.json();
            });
    }
</script>
</body>
</html>
